# Twitter Searches
# This progam searches twitter for tweets with the specified keywords and
# writes the results into a spreadsheet.

import tweepy
import time
import xlsxwriter

# create workbook
newfile = "ParisTweets.xlsx"
openworkbook = xlsxwriter.Workbook(newfile)

# authorize access
username = ***
password = ***
consumer_token = ***
consumer_sercret = ***

auth = tweepy.OAuthHandler( consumer_token, consumer_sercret )

access_token = ***
access_secret = ***

auth = tweepy.OAuthHandler(consumer_token, consumer_sercret)
auth.set_access_token(access_token, access_secret)
api = tweepy.API(auth)

# add keywords together
def masterlist(list1, list2):
    # an empty temporary list is defined
    templist = []
    # every item in list1
    for x in range(0,len(list1)):
        # every item in list2
        for y in range(0,len(list2)):
            # add together the keywords
            item = "'" + list1[x] + "'" + " AND " + "'" + list2[y] + "'"
            # add them to the temporary list
            templist.append(item)
            
    # return temporary list
    return templist

# set up search parameters: keywords and search dates
keywords = [ "#ParisAttack", "#ParisShooting", "Paris attack", "Paris shooting" ]
keywords_news = [ "CNN", "Fox News", "BBC" ]
searchdates = [ "2015-011-13", "2015-011-14", "2015-011-15", "2015-011-16" ]

# add keyword lists together
masterlist = masterlist( keywords, keywords_news )

# search function
def search(searchitem, start, end, workbook):
    
    # add worksheet to workbook
    worksheet = workbook.add_worksheet()
    
    # create titles for columns
    worksheet.write("A1", "Number of Tweets")
    worksheet.write("B1", "Date")
    worksheet.write("C1", "Time")
    worksheet.write("D1", "Username")
    worksheet.write("E1", "News Org")
    worksheet.write("F1", "Source")
    worksheet.write("G1", "Code")
    worksheet.write("H1", "Tweet")
    
    #define empty list/count
    totaldata = []
    
    #run search
    itsasearch = tweepy.Cursor(api.search,q=searchitem, since=start, \
    until=end, lang="en").items()
    
    #write search into spreadsheet
    while True:
        try:
            # define initial parameters
            NewsOrg = "Random Person"
            retweet = "N"
            
            # data from tweet defined
            tweetdata = itsasearch.next()
            
            # tweet data split into a list
            tweetnums = str(tweetdata.created_at).split(" ")
            # date taken from list
            date = tweetnums[0]
            # time taken from list
            tweettime = tweetnums[1]
            
            # username, display name and tweet taken from data
            username = tweetdata.user.screen_name
            Source = tweetdata.user.name
            tweettext = tweetdata.text
            
            # code define as search terms
            Code = searchitem
            
            # check if source is a news organization or a random person
            if Source.find("CNN") != -1 or Source.find("FoxNews") != -1 or \
            Source.find("BBC") != -1:
                NewsOrg = "News Org"
            
            # check if tweet is original or not
            if tweettext.find("@") != -1:
                retweet = "Y"
            
            # if tweet is not a retweet, create a list of relevant info
            if retweet == "N":            
                inddata = [ date, tweettime, username, NewsOrg, Source, Code, \
                tweettext ]
                totaldata.append( inddata )
        
        # if search quota met, wait 15 min and continue search
        except tweepy.TweepError:
            print("Waiting to continue search...")
            time.sleep(60 * 15)
            print("Continuing Search!")
            print("\n")
            continue
        
        # break loop when search ends
        except StopIteration:
            break
        
    # write data from every tweet into worksheet
    for i in range(1, len(totaldata)):
        worksheet.write("A" + str(i+1), i)
        worksheet.write("B" + str(i+1), totaldata[i-1][0])
        worksheet.write("C" + str(i+1), totaldata[i-1][1])
        worksheet.write("D" + str(i+1), totaldata[i-1][2])
        worksheet.write("E" + str(i+1), totaldata[i-1][3])
        worksheet.write("F" + str(i+1), totaldata[i-1][4])
        worksheet.write("G" + str(i+1), totaldata[i-1][5])
        worksheet.write("H" + str(i+1), totaldata[i-1][6])

# run searches
for word in masterlist:
    for n in range(0,len(searchdates)-1):
        search( word, searchdates[n], searchdates[n+1], openworkbook )
